#include "Common.h"
#include "delay.h"
#include "TSSD1306.h"
#include "i2c_handler.h"
#include "stdio.h"

uint8_t OLED_WIDTH = 128;
uint8_t OLED_HEIGHT=64;
uint8_t OLED_ADD=0x78;
uint8_t OLED_Col_Offset=0;
uint8_t SSD1306_COMPINMODE=0x02;
uint8_t OLED_currLine=0,OLED_currCol=0;
uint8_t ActiveFont = 1,ACTIVE_FONT_WIDTH=3,mPlex=0x3F;


//power up Sequence
#define SSD1306_SETLOWCOLUMN 0x00
/** Set Higher Column Start Address for Page Addressing Mode. */
#define SSD1306_SETHIGHCOLUMN 0x10
/** Set Memory Addressing Mode. */
#define SSD1306_MEMORYMODE 0x20
/** Set display RAM display start line register from 0 - 63. */
#define SSD1306_SETSTARTLINE 0x40
/** Set Display Contrast to one of 256 steps. */
#define SSD1306_SETCONTRAST 0x81
/** Enable or disable charge pump.  Follow with 0X14 enable, 0X10 disable. */
#define SSD1306_CHARGEPUMP 0x8D
/** Set Segment Re-map between data column and the segment driver. */
#define SSD1306_SEGREMAP 0xA0
/** Resume display from GRAM content. */
#define SSD1306_DISPLAYALLON_RESUME 0xA4
/** Force display on regardless of GRAM content. */
#define SSD1306_DISPLAYALLON 0xA5
/** Set Normal Display. */
#define SSD1306_NORMALDISPLAY 0xA6
/** Set Inverse Display. */
#define SSD1306_INVERTDISPLAY 0xA7
/** Set Multiplex Ratio from 16 to 63. */
#define SSD1306_SETMULTIPLEX 0xA8
/** Set Display off. */
#define SSD1306_DISPLAYOFF 0xAE
/** Set Display on. */
#define SSD1306_DISPLAYON 0xAF
/**Set GDDRAM Page Start Address. */
#define SSD1306_SETSTARTPAGE 0XB0
/** Set COM output scan direction normal. */
#define SSD1306_COMSCANINC 0xC0
/** Set COM output scan direction reversed. */
#define SSD1306_COMSCANDEC 0xC8
/** Set Display Offset. */
#define SSD1306_SETDISPLAYOFFSET 0xD3
/** Sets COM signals pin configuration to match the OLED panel layout. */
#define SSD1306_SETCOMPINS 0xDA
/** This command adjusts the VCOMH regulator output. */
#define SSD1306_SETVCOMDETECT 0xDB
/** Set Display Clock Divide Ratio/ Oscillator Frequency. */
#define SSD1306_SETDISPLAYCLOCKDIV 0xD5
/** Set Pre-charge Period */
#define SSD1306_SETPRECHARGE 0xD9
/** No Operation Command. */
#define SSD1306_NOP 0XE3





#define CMDS	0x00
#define CMD		0x80
#define DATS	0x40
#define DAT		0xC0
#define ACTIVE_FONT_SPACING 1


const uint8_t code font[2][475] =
{
	{
	0x00, 0x00, 0x00, 0x00, 0x00, // SPACE
	0x00, 0x00, 0x5F, 0x00, 0x00, // !
	0x00, 0x03, 0x00, 0x03, 0x00, // "
	0x14, 0x3E, 0x14, 0x3E, 0x14, // #
	0x24, 0x2A, 0x7F, 0x2A, 0x12, // $
	0x43, 0x33, 0x08, 0x66, 0x61, // %
	0x36, 0x49, 0x55, 0x22, 0x50, // &
	0x00, 0x05, 0x03, 0x00, 0x00, // '
	0x00, 0x1C, 0x22, 0x41, 0x00, // (
	0x00, 0x41, 0x22, 0x1C, 0x00, // )
	0x14, 0x08, 0x3E, 0x08, 0x14, // *
	0x08, 0x08, 0x3E, 0x08, 0x08, // +
	0x00, 0x50, 0x30, 0x00, 0x00, // ,
	0x08, 0x08, 0x08, 0x08, 0x08, // -
	0x00, 0x60, 0x60, 0x00, 0x00, // .
	0x20, 0x10, 0x08, 0x04, 0x02, // /
	0x3E, 0x51, 0x49, 0x45, 0x3E, // 0
	0x00, 0x04, 0x02, 0x7F, 0x00, // 1
	0x42, 0x61, 0x51, 0x49, 0x46, // 2
	0x22, 0x41, 0x49, 0x49, 0x36, // 3
	0x18, 0x14, 0x12, 0x7F, 0x10, // 4
	0x27, 0x45, 0x45, 0x45, 0x39, // 5
	0x3E, 0x49, 0x49, 0x49, 0x32, // 6
	0x01, 0x01, 0x71, 0x09, 0x07, // 7
	0x36, 0x49, 0x49, 0x49, 0x36, // 8
	0x26, 0x49, 0x49, 0x49, 0x3E, // 9
	0x00, 0x36, 0x36, 0x00, 0x00, // :
	0x00, 0x56, 0x36, 0x00, 0x00, // ;
	0x08, 0x14, 0x22, 0x41, 0x00, // <
	0x14, 0x14, 0x14, 0x14, 0x14, // =
	0x00, 0x41, 0x22, 0x14, 0x08, // >
	0x02, 0x01, 0x51, 0x09, 0x06, // ?
	0x3E, 0x41, 0x59, 0x55, 0x5E, // @
	0x7E, 0x09, 0x09, 0x09, 0x7E, // A
	0x7F, 0x49, 0x49, 0x49, 0x36, // B
	0x3E, 0x41, 0x41, 0x41, 0x22, // C
	0x7F, 0x41, 0x41, 0x41, 0x3E, // D
	0x7F, 0x49, 0x49, 0x49, 0x41, // E
	0x7F, 0x09, 0x09, 0x09, 0x01, // F
	0x3E, 0x41, 0x41, 0x49, 0x3A, // G
	0x7F, 0x08, 0x08, 0x08, 0x7F, // H
	0x00, 0x41, 0x7F, 0x41, 0x00, // I
	0x30, 0x40, 0x40, 0x40, 0x3F, // J
	0x7F, 0x08, 0x14, 0x22, 0x41, // K
	0x7F, 0x40, 0x40, 0x40, 0x40, // L
	0x7F, 0x02, 0x0C, 0x02, 0x7F, // M
	0x7F, 0x02, 0x04, 0x08, 0x7F, // N
	0x3E, 0x41, 0x41, 0x41, 0x3E, // O
	0x7F, 0x09, 0x09, 0x09, 0x06, // P
	0x1E, 0x21, 0x21, 0x21, 0x5E, // Q
	0x7F, 0x09, 0x09, 0x09, 0x76, // R
	0x26, 0x49, 0x49, 0x49, 0x32, // S
	0x01, 0x01, 0x7F, 0x01, 0x01, // T
	0x3F, 0x40, 0x40, 0x40, 0x3F, // U
	0x1F, 0x20, 0x40, 0x20, 0x1F, // V
	0x7F, 0x20, 0x10, 0x20, 0x7F, // W
	0x41, 0x22, 0x1C, 0x22, 0x41, // X
	0x07, 0x08, 0x70, 0x08, 0x07, // Y
	0x61, 0x51, 0x49, 0x45, 0x43, // Z
	0x00, 0x7F, 0x41, 0x00, 0x00, // [
	0x02, 0x04, 0x08, 0x10, 0x20, // backslash
	0x00, 0x00, 0x41, 0x7F, 0x00, // ]
	0x04, 0x02, 0x01, 0x02, 0x04, // ^
	0x40, 0x40, 0x40, 0x40, 0x40, // _
	0x00, 0x01, 0x02, 0x04, 0x00, // `
	0x20, 0x54, 0x54, 0x54, 0x78, // a
	0x7F, 0x44, 0x44, 0x44, 0x38, // b
	0x38, 0x44, 0x44, 0x44, 0x44, // c
	0x38, 0x44, 0x44, 0x44, 0x7F, // d
	0x38, 0x54, 0x54, 0x54, 0x18, // e
	0x04, 0x04, 0x7E, 0x05, 0x05, // f
	0x08, 0x54, 0x54, 0x54, 0x3C, // g
	0x7F, 0x08, 0x04, 0x04, 0x78, // h
	0x00, 0x44, 0x7D, 0x40, 0x00, // i
	0x20, 0x40, 0x44, 0x3D, 0x00, // j
	0x7F, 0x10, 0x28, 0x44, 0x00, // k
	0x00, 0x41, 0x7F, 0x40, 0x00, // l
	0x7C, 0x04, 0x78, 0x04, 0x78, // m
	0x7C, 0x08, 0x04, 0x04, 0x78, // n
	0x38, 0x44, 0x44, 0x44, 0x38, // o
	0x7C, 0x14, 0x14, 0x14, 0x08, // p
	0x08, 0x14, 0x14, 0x14, 0x7C, // q
	0x00, 0x7C, 0x08, 0x04, 0x04, // r
	0x48, 0x54, 0x54, 0x54, 0x20, // s
	0x04, 0x04, 0x3F, 0x44, 0x44, // t
	0x3C, 0x40, 0x40, 0x20, 0x7C, // u
	0x1C, 0x20, 0x40, 0x20, 0x1C, // v
	0x3C, 0x40, 0x30, 0x40, 0x3C, // w
	0x44, 0x28, 0x10, 0x28, 0x44, // x
	0x0C, 0x50, 0x50, 0x50, 0x3C, // y
	0x44, 0x64, 0x54, 0x4C, 0x44, // z
	0x00, 0x08, 0x36, 0x41, 0x41, // {
	0x00, 0x00, 0x7F, 0x00, 0x00, // |
	0x41, 0x41, 0x36, 0x08, 0x00, // }
	0x02, 0x01, 0x02, 0x04, 0x02, // ~
}
,{
	0x00,0x00,0x00, //
	0x00,0x5c,0x00, // !
	0x0C,0x00,0x0C, // "
	0x7C,0x28,0x7C, // #
	0x28,0x7C,0x14, // $
	0x24,0x10,0x48, // %
	0x3C,0x5C,0x70, // &
	0x00,0x0C,0x00, // '
	0x00,0x38,0x44, // (
	0x44,0x38,0x00, // )
	0x14,0x08,0x14, // *
	0x10,0x38,0x10, // +
	0x40,0x20,0x00, // ,
	0x10,0x10,0x10, // -
	0x00,0x40,0x00, // .
	0x60,0x10,0x0C, // /
	0x78,0x44,0x3C, // 0
	0x08,0x7C,0x00, // 1
	0x64,0x54,0x48, // 2
	0x44,0x54,0x28, // 3
	0x1C,0x10,0x7C, // 4
	0x5C,0x54,0x24, // 5
	0x78,0x54,0x74, // 6
	0x64,0x14,0x0C, // 7
	0x7C,0x54,0x7C, // 8
	0x5C,0x54,0x3C, // 9
	0x00,0x28,0x00, // :
	0x40,0x28,0x00, // ;
	0x10,0x28,0x44, // <
	0x28,0x28,0x28, // =
	0x44,0x28,0x10, // >
	0x04,0x54,0x0C, // ?
	0x38,0x54,0x58, // @
	0x78,0x14,0x78, // A
	0x7C,0x54,0x28, // B
	0x38,0x44,0x44, // C
	0x7C,0x44,0x38, // D
	0x7C,0x54,0x54, // E
	0x7C,0x14,0x14, // F
	0x38,0x54,0x74, // G
	0x7C,0x10,0x7C, // H
	0x44,0x7C,0x44, // I
	0x20,0x40,0x3C, // J
	0x7C,0x10,0x6C, // K
	0x7C,0x40,0x40, // L
	0x7C,0x18,0x7C, // M
	0x7C,0x38,0x7C, // N
	0x38,0x44,0x38, // O
	0x7C,0x14,0x08, // P
	0x38,0x64,0x78, // Q
	0x7C,0x34,0x58, // R
	0x48,0x54,0x24, // S
	0x04,0x7C,0x04, // T
	0x3C,0x40,0x7C, // U
	0x1C,0x20,0x1C, // V
	0x7C,0x30,0x7C, // W
	0x6C,0x10,0x6C, // X
	0x0C,0x70,0x0C, // Y
	0x64,0x54,0x4C, // Z
	0x7C,0x44,0x44, // [
	0x08,0x10,0x20, // (backspace)
	0x44,0x44,0x7C, // ]
	0x08,0x04,0x08, // ^
	0x40,0x40,0x40, // _
	0x04,0x08,0x00, // `
	0x68,0x58,0x70, // a
	0x7C,0x48,0x30, // b
	0x30,0x48,0x48, // c
	0x30,0x48,0x7C, // d
	0x30,0x68,0x58, // e
	0x10,0x78,0x14, // f
	0x30,0xA8,0x78, // g
	0x7C,0x08,0x70, // h
	0x00,0x74,0x00, // i
	0x40,0x80,0x74, // j
	0x7C,0x30,0x48, // k
	0x44,0x7C,0x40, // l
	0x78,0x38,0x78, // m
	0x78,0x08,0x70, // n
	0x30,0x48,0x30, // o
	0xF8,0x48,0x30, // p
	0x30,0x48,0xF8, // q
	0x70,0x08,0x08, // r
	0x50,0x78,0x28, // s
	0x08,0x7C,0x48, // t
	0x38,0x40,0x78, // u
	0x38,0x60,0x38, // v
	0x78,0x70,0x78, // w
	0x48,0x30,0x48, // x
	0x18,0xA0,0x78, // y
	0x68,0x78,0x58, // z
	0x10,0x6C,0x44, // {
	0x00,0x6C,0x00, // |
	0x44,0x6C,0x10, // }
	0x08,0x0C,0x04, //

}
};

void OLED_Settings(uint8_t oAdd,uint8_t width, uint8_t height)
{
	OLED_WIDTH = width;
	OLED_HEIGHT = height;
	OLED_ADD=oAdd;
	if(OLED_HEIGHT > 32)	SSD1306_COMPINMODE = 0x12;
	else	SSD1306_COMPINMODE = 0x02;
	if(OLED_HEIGHT == 32)	mPlex = 0x1F;
	else if(OLED_HEIGHT == 48)
	{
		mPlex = 0x2F;
		OLED_Col_Offset = 32;
	}
	else mPlex = 0x3F;
}

void OLED_SetFont(uint8_t fnt)
{
	ActiveFont=fnt;
	if(fnt == 0)
		ACTIVE_FONT_WIDTH = 5;
	else
		ACTIVE_FONT_WIDTH = 3;
}
void OLED_Init()
{
	i2c_init();
	i2c_start(OLED_ADD);
	i2c_write(CMDS);
	i2c_write(SSD1306_DISPLAYOFF);
	i2c_write(SSD1306_SETDISPLAYCLOCKDIV);
	i2c_write(0x80);
	
	i2c_write(SSD1306_SETMULTIPLEX);
	i2c_write(mPlex);
	
	i2c_write(SSD1306_SETDISPLAYOFFSET | 0x00);
	
	i2c_write(SSD1306_SETSTARTLINE | 0x00);
	
	i2c_write(SSD1306_CHARGEPUMP);
	i2c_write(0x14);
	
	i2c_write(0x20);
	i2c_write(0x02);
	
	i2c_write(SSD1306_SEGREMAP | 0x01);
	
	i2c_write(SSD1306_COMSCANDEC);
	
	i2c_write(SSD1306_SETCOMPINS);
	i2c_write(SSD1306_COMPINMODE);		//Set to 0x12 if height is bigger than 32
	
	i2c_write(SSD1306_SETCONTRAST);
	i2c_write(0x80);
	
	i2c_write(SSD1306_SETPRECHARGE);
	i2c_write(0xF1);
	
	i2c_write(SSD1306_SETVCOMDETECT);
	i2c_write(0x40);
	
	i2c_write(0xA6);
	i2c_write(0xA4);
	
	i2c_write(0x21);
	i2c_write(0x0);
	i2c_write(OLED_WIDTH-1);
	
	i2c_write(0x22);
	i2c_write(0);
	i2c_write((OLED_HEIGHT/8)-1);
	
	i2c_write(0xAF);
	i2c_stop();
//	OLED_Clear();
//	OLED_Write("With many thanx to :");
//	Timer3_Delay100ms(6);
//	OLED_SetCursor(2,8);
//	OLED_SetFont(0);
//	OLED_Write("Aftabrayaneh Staff");
//	Timer3_Delay100ms(19);
//	OLED_Clear();
//	OLED_SetFont(1);
//	OLED_Write("Written By :");
//	OLED_SetFont(0);
//	OLED_SetCursor(1,8);
//	OLED_Write("Tirdad Sadri Nejad");
//	OLED_SetCursor(3,0);
//	OLED_Write("Tirdad_ms@hotmail.com");
//	Timer3_Delay100ms(30);
}


void OLED_SetCursor(uint8_t line,uint8_t column)
{
	i2c_start(OLED_ADD);
	i2c_write(CMDS);
	
	i2c_write(0x21);
	i2c_write(column%OLED_WIDTH);
	i2c_write(OLED_WIDTH-1);
	
	i2c_write(0x22);
	i2c_write(line%(OLED_HEIGHT/8));
	i2c_write((OLED_HEIGHT/8)-1);
	i2c_stop();
	OLED_currLine = line;
	OLED_currCol	 = column;
}

void OLED_ClearLine(uint8_t line)
{
	uint8_t i;
	OLED_SetCursor(line,0);
	i2c_start(OLED_ADD);
	i2c_write(DATS);
	for (i=0; i<OLED_WIDTH;i++)
	{
		i2c_write(0x00);
	}
	i2c_stop();
	OLED_SetCursor(line,0);
}


void OLED_ClearField(uint8_t line, uint8_t bgn, uint8_t end)
{
	uint8_t i;
	OLED_SetCursor(line,bgn);
	i2c_start(OLED_ADD);
	i2c_write(DATS);
	for (i=0;i<end;i++)
	{
		i2c_write(0x00);
	}
	i2c_stop();
	OLED_SetCursor(line,bgn);
}

void OLED_Clear()
{
	uint8_t i,j;
	for (j=0; j<OLED_HEIGHT/8;j++)
	{
		OLED_SetCursor(j,0);
		i2c_start(OLED_ADD);
		i2c_write(DATS);
		for (i=0;i<OLED_WIDTH;i++)	i2c_write(0x00);
		i2c_stop();
	}
	OLED_SetCursor(0,0);
}

void OLED_WriteChar(uint8_t oled_char)
{
	uint8_t i;
	oled_char = oled_char-32;
	i2c_start(OLED_ADD);
	i2c_write(DATS);
	for (i=0; i<ACTIVE_FONT_WIDTH;i++)
	{
		i2c_write((font[ActiveFont][(oled_char*ACTIVE_FONT_WIDTH)+i]));
	}
	for(i=0;i<ACTIVE_FONT_SPACING;i++)
	{
		i2c_write(0x00);
	}
	i2c_stop();
	OLED_currCol += ACTIVE_FONT_WIDTH + ACTIVE_FONT_SPACING;
	if (OLED_currCol > OLED_WIDTH-(ACTIVE_FONT_SPACING + ACTIVE_FONT_WIDTH))
	{
		if(OLED_currLine < (OLED_HEIGHT/8)-1) 
		{
			OLED_SetCursor(OLED_currLine+1,0);
		}
		else 
		{
			OLED_Clear();
		}
	}
}

void OLED_Write(char const* str)
{
	uint8_t i=0;
	
	while(str[i] != '\0')
	{
		OLED_WriteChar(str[i]);
		i++;
	}
}
void OLED_WriteINT(int num)
{
	char buff[12];
	sprintf(buff,"%i",num);
	OLED_Write(buff);
}
void OLED_SetContrast(uint8_t cntr)
{
	i2c_start(OLED_ADD)	;
	i2c_write(CMDS);
	i2c_write(SSD1306_SETCONTRAST);
	i2c_write(cntr);
	i2c_stop();
}